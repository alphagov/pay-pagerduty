#!/usr/bin/env ruby

require 'dotenv/load'
require 'httparty'
require 'pry'
require 'date'
require 'csv'

$LOAD_PATH << File.dirname(__FILE__) + "/../lib/"
require 'rotation'
require 'rota'
require 'pager_duty'

rota_file = File.dirname(__FILE__) + "/../data/rota.csv"
user_file = File.dirname(__FILE__) + "/../data/users.csv"
schedules_file = File.dirname(__FILE__) + "/../data/schedules.csv"

rota = Rota.new(rota_file: rota_file, users_file: user_file, schedules_file: schedules_file)

pd = PagerDuty.new(api_token: ENV.fetch('PAGER_DUTY_API_KEY'))

raw_schedule = pd.schedule(rota.schedule_id("In Hours 1"), rota.from, rota.to)

actual_schedule = raw_schedule['schedule']['final_schedule']['rendered_schedule_entries']

users = pd.users

rota.rotations("In Hours 1").each do |rotation|
  overlaps = actual_schedule.select { |s| rotation.includes?(s) }
  invalid = overlaps.reject {|actual| rotation.valid?(actual)}

  if invalid.any?
    puts "#{rotation.start} - #{rotation.name} has invalid entries:"
    invalid.each do |i|
      puts "  #{i['start']} - #{i['end']} - #{i['user']['summary']}" 
    end
  end
end
